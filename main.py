import asyncio
import sqlite3
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.filters import Command, Text
from aiogram.types import Message, CallbackQuery

# ----------------------
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# ----------------------
API_TOKEN = "8385307802:AAE0AJGb8T9RQauVVpLzmFKR1jchrcVZR2c"
OWNER_ID = 8379101989  # Telegram ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–∞–¥–º–∏–Ω–∞)
DB_FILENAME = "shifts.db"

# ----------------------
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
# ----------------------
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# ----------------------
# FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è
# ----------------------
class ShiftStates(StatesGroup):
    adding_car = State()    # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –º–∞—à–∏–Ω—ã
    editing_car = State()   # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –¥–ª—è –º–∞—à–∏–Ω—ã
    none = State()          # –ù—É–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–ª—è —è–≤–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞)

class HistoryStates(StatesGroup):
    browsing = State()      # –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω

# ----------------------
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
# ----------------------
conn = sqlite3.connect(DB_FILENAME)
cursor = conn.cursor()

# –¢–∞–±–ª–∏—Ü–∞ —Å–º–µ–Ω
cursor.execute("""
CREATE TABLE IF NOT EXISTS shifts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    start_time TEXT,
    end_time TEXT,
    total_sum INTEGER
)
""")

# –¢–∞–±–ª–∏—Ü–∞ –º–∞—à–∏–Ω –≤ —Å–º–µ–Ω–µ
cursor.execute("""
CREATE TABLE IF NOT EXISTS cars (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    shift_id INTEGER,
    car_number TEXT,
    sum INTEGER,
    FOREIGN KEY (shift_id) REFERENCES shifts(id)
)
""")

# –¢–∞–±–ª–∏—Ü–∞ —É—Å–ª—É–≥ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã
cursor.execute("""
CREATE TABLE IF NOT EXISTS services (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    car_id INTEGER,
    name TEXT,
    count INTEGER,
    price INTEGER,
    FOREIGN KEY (car_id) REFERENCES cars(id)
)
""")
conn.commit()

# ----------------------
# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞)
# ----------------------
SERVICES = [
    ("–ü—Ä–æ–≤–µ—Ä–∫–∞", 115), ("–ó–∞–ø—Ä–∞–≤–∫–∞", 198), ("–ü–æ–¥–∫–∞—á–∫–∞", 75), 
    ("–ó–∞–ª–∏–≤–∫–∞ –æ–º—ã–≤–∞–π–∫–∏", 66), ("–ü–µ—Ä–µ–≥–æ–Ω –Ω–∞ –°–¢–û", 254),
    ("–ó–∞—Ä—è–¥–∫–∞ –ê–ö–ë", 125), ("–ù–µ—Ç —Å–ø—É—Ç–Ω–∏–∫–∞", 398), ("–†–∞–∑–≤–æ–∑ –¥–æ 3 —á–∞—Å–æ–≤", 373),
    ("–†–∞–∑–≤–æ–∑ –¥–æ 5 —á–∞—Å–æ–≤", 747), ("–°—Ä–æ—á–∫–∞", 220), ("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã", 93),
    ("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–æ–¥–æ–≤–æ–π", 115), ("–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è", 83),
    ("–ü–µ—Ä–µ–ø–∞—Ä–∫–æ–≤–∫–∞ –¢–°", 150), ("–°—É–≥—Ä–æ–± –ø—Ä–æ—Å—Ç–æ–π", 160), ("–†–∞—Å–∫–ª–∞–¥–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", 31),
    ("–ß–µ–∫", 50), ("–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –¢–° –¥–æ 20–∫–º", 320), ("–ó–∞–º–µ–Ω–∞ –ª–∞–º–ø–æ—á–∫–∏", 31),
    ("–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ì–†–ó", 31), ("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–æ—Ä–Ω–∏–∫–∞", 74), ("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–µ—Ä–∫–∞–ª–∞", 74),
    ("–ó–∞–ø—Ä–∞–≤–∫–∞ –∏–∑ –∫–∞–Ω–∏—Å—Ç—Ä—ã", 278), ("–î–æ–ª–∏–≤ —Ç–µ—Ö. –∂–∏–¥–∫–æ—Å—Ç–µ–π", 77), 
    ("–°—É–≥—Ä–æ–± —Å–ª–æ–∂–Ω—ã–π", 902), ("–£–¥–∞–ª–µ–Ω–Ω–∞—è –∑–∞–ø—Ä–∞–≤–∫–∞", 545)
]

SERVICES_PER_PAGE = 5  # —É—Å–ª—É–≥–∏ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

# ----------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ FSM
# ----------------------
def get_active_shift():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –∏–ª–∏ None."""
    cursor.execute("SELECT id FROM shifts WHERE end_time IS NULL ORDER BY id DESC LIMIT 1")
    row = cursor.fetchone()
    return row[0] if row else None

def open_shift():
    """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Å–º–µ–Ω—É, —Ñ–∏–∫—Å–∏—Ä—É—è –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞."""
    cursor.execute("INSERT INTO shifts (start_time) VALUES (datetime('now','localtime'))")
    conn.commit()
    return cursor.lastrowid

def close_shift(shift_id):
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É, —Ñ–∏–∫—Å–∏—Ä—É—è –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ —Å—É–º–º–∞—Ä–Ω—É—é —Å—É–º–º—É."""
    cursor.execute("""
        SELECT SUM(services.price * services.count)
        FROM cars 
        JOIN services ON cars.id = services.car_id 
        WHERE cars.shift_id = ?
    """, (shift_id,))
    total = cursor.fetchone()[0] or 0
    cursor.execute("""
        UPDATE shifts
        SET end_time = datetime('now','localtime'), total_sum = ?
        WHERE id = ?
    """, (total, shift_id))
    conn.commit()
    return total

def record_car(shift_id, car_number, services_list):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–∞—à–∏–Ω—É –∏ –µ—ë —É—Å–ª—É–≥–∏ –≤ –ë–î, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–æ –º–∞—à–∏–Ω–µ."""
    total = 0
    cursor.execute("INSERT INTO cars (shift_id, car_number, sum) VALUES (?, ?, ?)", (shift_id, car_number, 0))
    car_id = cursor.lastrowid
    for name, count, price in services_list:
        if count > 0:
            cursor.execute("INSERT INTO services (car_id, name, count, price) VALUES (?, ?, ?, ?)",
                           (car_id, name, count, price))
            total += price * count
    cursor.execute("UPDATE cars SET sum = ? WHERE id = ?", (total, car_id))
    conn.commit()
    return total

def format_shift_summary(shift_id):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞ –ø–æ —Å–º–µ–Ω–µ: —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω –∏ –∏—Ç–æ–≥."""
    lines = []
    cursor.execute("SELECT car_number, sum, id FROM cars WHERE shift_id = ?", (shift_id,))
    cars = cursor.fetchall()
    total = 0
    for car_number, car_sum, car_id in cars:
        lines.append(f"–ú–∞—à–∏–Ω–∞ {car_number}: {car_sum} —Ä—É–±.")
        total += car_sum
    summary = "\n".join(lines)
    summary += f"\n\n–í—Å–µ–≥–æ: {total} —Ä—É–±."
    return summary

def format_history_item(shift_id):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω—ã."""
    cursor.execute("SELECT start_time, end_time, total_sum FROM shifts WHERE id = ?", (shift_id,))
    row = cursor.fetchone()
    if not row:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–º–µ–Ω–∞"
    start, end, total = row
    if end:
        return f"{start} ‚Äì {end} (–≤—Å–µ–≥–æ {total} —Ä—É–±.)"
    else:
        return f"{start} ‚Äì *–∞–∫—Ç–∏–≤–Ω–∞*"

def find_repeats(shift_id):
    """–ò—â–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –º–∞—à–∏–Ω—ã/—É—Å–ª—É–≥–∏ –≤ —Å–º–µ–Ω–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞."""
    cursor.execute("SELECT car_number, COUNT(*) FROM cars WHERE shift_id = ? GROUP BY car_number HAVING COUNT(*) > 1", (shift_id,))
    cars = cursor.fetchall()
    cursor.execute("""
        SELECT services.name, SUM(services.count) 
        FROM cars JOIN services ON cars.id = services.car_id
        WHERE cars.shift_id = ?
        GROUP BY services.name
        HAVING SUM(services.count) > 1
    """, (shift_id,))
    services = cursor.fetchall()
    parts = []
    if cars:
        parts.append("–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –Ω–æ–º–µ—Ä–∞ –º–∞—à–∏–Ω:")
        for car, cnt in cars:
            parts.append(f"- {car} ({cnt} —Ä–∞–∑–∞)")
    if services:
        parts.append("–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —É—Å–ª—É–≥–∏ (—Å—É–º–º–∞—Ä–Ω–æ):")
        for name, cnt in services:
            parts.append(f"- {name}: {cnt} —Ä–∞–∑")
    return "\n".join(parts) if parts else "–ü–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

# ----------------------
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–ø–∞–Ω–µ–ª—å —Å–º–µ–Ω—ã)
# ----------------------
def get_shift_panel(active_shift: bool = False):
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    if active_shift:
        kb.add(KeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É"))
        kb.add(KeyboardButton("üìä –ò—Ç–æ–≥–∏ —Å–º–µ–Ω—ã"), KeyboardButton("‚è± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ"))
        kb.add(KeyboardButton("üìú –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω"))
        kb.add(KeyboardButton("‚õî –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É"))
    else:
        kb.add(KeyboardButton("–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É"))
    return kb

# ----------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
# ----------------------
@dp.message(Command(commands=["start", "menu"]))
async def cmd_start(message: Message, state: FSMContext):
    """–°—Ç–∞—Ä—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤, –ø–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    if message.from_user.id != OWNER_ID:
        await message.reply("–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    await state.clear()
    shift_id = get_active_shift()
    text = "–°–º–µ–Ω–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞. –ü–∞–Ω–µ–ª—å —Å–º–µ–Ω—ã:" if shift_id else "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –°–º–µ–Ω–∞ –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞."
    await message.answer(text, reply_markup=get_shift_panel(active_shift=bool(shift_id)))

# ----------------------
# –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
# ----------------------
@dp.message(Text(equals="–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É"))
async def open_shift_handler(message: Message):
    if message.from_user.id != OWNER_ID:
        return
    if get_active_shift():
        await message.answer("–°–º–µ–Ω–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=True))
        return
    shift_id = open_shift()
    await message.answer("–°–º–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=True))

@dp.message(Text(equals="‚õî –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É"))
async def close_shift_handler(message: Message):
    if message.from_user.id != OWNER_ID:
        return
    shift_id = get_active_shift()
    if not shift_id:
        await message.answer("–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=False))
        return
    total = close_shift(shift_id)
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç—á—ë—Ç—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    markup = InlineKeyboardMarkup(row_width=2)
    markup.add(
        InlineKeyboardButton(text="üí∞ –î–µ–Ω–µ–∂–Ω—ã–π –æ—Ç—á—ë—Ç", callback_data="report_money"),
        InlineKeyboardButton(text="üîÅ –û—Ç—á—ë—Ç –ø–æ–≤—Ç–æ—Ä–æ–∫", callback_data="report_repeats")
    )
    await message.answer(f"–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞. –ò—Ç–æ–≥–æ: {total} —Ä—É–±.\n–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç:", reply_markup=markup)

# ----------------------
# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
# ----------------------
@dp.message(Text(equals="üìä –ò—Ç–æ–≥–∏ —Å–º–µ–Ω—ã"))
async def interim_report_handler(message: Message):
    if message.from_user.id != OWNER_ID:
        return
    shift_id = get_active_shift()
    if not shift_id:
        await message.answer("–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=False))
        return
    summary = format_shift_summary(shift_id)
    await message.answer("üìä –ò—Ç–æ–≥–∏ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã:\n" + summary, reply_markup=get_shift_panel(active_shift=True))

@dp.message(Text(equals="‚è± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ"))
async def shift_info_handler(message: Message):
    if message.from_user.id != OWNER_ID:
        return
    shift_id = get_active_shift()
    if not shift_id:
        await message.answer("–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=False))
        return
    cursor.execute("SELECT start_time FROM shifts WHERE id = ?", (shift_id,))
    start = cursor.fetchone()[0]
    cursor.execute("SELECT (strftime('%s','now') - strftime('%s',start_time)) FROM shifts WHERE id = ?", (shift_id,))
    seconds = cursor.fetchone()[0]
    hours = seconds // 3600
    minutes = (seconds % 3600) // 60
    await message.answer(f"–°–º–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞: {start}\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {hours} —á {minutes} –º–∏–Ω.\n–ú–∞—à–∏–Ω/—á–∞—Å: N/A",
                         reply_markup=get_shift_panel(active_shift=True))

# ----------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Inline-–∫–Ω–æ–ø–æ–∫ –æ—Ç—á—ë—Ç–æ–≤
# ----------------------
@dp.callback_query(Text(equals="report_money"))
async def report_money_handler(callback: CallbackQuery):
    shift_id = cursor.execute("SELECT id FROM shifts WHERE end_time IS NOT NULL ORDER BY id DESC LIMIT 1").fetchone()[0]
    text = format_shift_summary(shift_id)
    await callback.message.answer("üí∞ –î–µ–Ω–µ–∂–Ω—ã–π –æ—Ç—á—ë—Ç:\n" + text)
    await callback.answer()

@dp.callback_query(Text(equals="report_repeats"))
async def report_repeats_handler(callback: CallbackQuery):
    shift_id = cursor.execute("SELECT id FROM shifts WHERE end_time IS NOT NULL ORDER BY id DESC LIMIT 1").fetchone()[0]
    text = find_repeats(shift_id)
    await callback.message.answer("üîÅ –û—Ç—á—ë—Ç –ø–æ–≤—Ç–æ—Ä–æ–∫:\n" + text)
    await callback.answer()

# ----------------------
# –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
# ----------------------
@dp.message(Text(equals="üìú –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω"))
async def history_handler(message: Message, state: FSMContext):
    if message.from_user.id != OWNER_ID:
        return
    await state.set_state(HistoryStates.browsing)
    cursor.execute("SELECT id FROM shifts ORDER BY id DESC")
    shifts = cursor.fetchall()
    if not shifts:
        await message.answer("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.", reply_markup=get_shift_panel(active_shift=bool(get_active_shift())))
        await state.clear()
        return
    markup = InlineKeyboardMarkup(row_width=1)
    for (sid,) in shifts:
        label = format_history_item(sid)
        markup.add(InlineKeyboardButton(text=label, callback_data=f"hist_{sid}"))
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É:", reply_markup=markup)

@dp.callback_query(lambda c: c.data and c.data.startswith("hist_"), state=HistoryStates.browsing)
async def history_view_handler(callback: CallbackQuery, state: FSMContext):
    _, sid_str = callback.data.split("_")
    sid = int(sid_str)
    cursor.execute("SELECT start_time, end_time, total_sum FROM shifts WHERE id = ?", (sid,))
    row = cursor.fetchone()
    text = f"–°–º–µ–Ω–∞ {sid}:\n"
    if row:
        start, end, total = row
        text += f"–ù–∞—á–∞–ª–æ: {start}\n–ö–æ–Ω–µ—Ü: {end}\n–ò—Ç–æ–≥: {total or 0} —Ä—É–±.\n\n"
        cursor.execute("SELECT car_number, sum, id FROM cars WHERE shift_id = ?", (sid,))
        cars = cursor.fetchall()
        if cars:
            text += "–ú–∞—à–∏–Ω—ã:\n"
            for car_number, car_sum, car_id in cars:
                text += f"- {car_number}: {car_sum} —Ä—É–±.\n"
                cursor.execute("SELECT name, count FROM services WHERE car_id = ?", (car_id,))
                services = cursor.fetchall()
                for name, count in services:
                    text += f"    ‚Ä¢ {name} √ó{count}\n"
        else:
            text += "–ù–µ—Ç –º–∞—à–∏–Ω.\n"
    markup = InlineKeyboardMarkup().add(InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="hist_back"))
    await callback.message.answer(text, reply_markup=markup)
    await callback.answer()

@dp.callback_query(Text(equals="hist_back"), state=HistoryStates.browsing)
async def history_back_handler(callback: CallbackQuery):
    await callback.message.delete()
    cursor.execute("SELECT id FROM shifts ORDER BY id DESC")
    shifts = cursor.fetchall()
    markup = InlineKeyboardMarkup(row_width=1)
    for (sid,) in shifts:
        label = format_history_item(sid)
        markup.add(InlineKeyboardButton(text=label, callback_data=f"hist_{sid}"))
    await callback.message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É:", reply_markup=markup)
    await callback.answer()

# ----------------------
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã: –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞
# ----------------------
@dp.message(Text(equals="‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É"))
async def add_car_start(message: Message, state: FSMContext):
    if message.from_user.id != OWNER_ID:
        return
    if not get_active_shift():
        await message.answer("–°–º–µ–Ω–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞.", reply_markup=get_shift_panel(active_shift=False))
        return
    await state.set_state(ShiftStates.adding_car)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, X360PY797):")

@dp.message(ShiftStates.adding_car)
async def add_car_number(message: Message, state: FSMContext):
    car_number = message.text.strip().upper()
    # –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ 797, –µ—Å–ª–∏ –Ω–µ—Ç
    if len(car_number) <= 6 or not car_number[-3:].isdigit():
        car_number += "797"
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (–±—É–∫–≤—ã –ª–∞—Ç–∏–Ω–∏—Ü–µ–π, —Ü–∏—Ñ—Ä—ã)
    import re
    if not re.match(r'^[A-Z0-9]{6,10}$', car_number):
        await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return
    await state.update_data(car_number=car_number, services={}, delete_mode=False)
    await state.set_state(ShiftStates.editing_car)
    await show_services_page(message, state, page=0)

# ----------------------
# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ª—É–≥
# ----------------------
async def show_services_page(message_or_callback, state: FSMContext, page: int):
    data = await state.get_data()
    car_number = data.get("car_number", "")
    services_count = data.get("services", {})

    header = f"–ú–∞—à–∏–Ω–∞ {car_number}\n–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ (–î–æ–±–∞–≤–ª–µ–Ω–∏–µ):"
    markup = InlineKeyboardMarkup(row_width=2)
    start = page * SERVICES_PER_PAGE
    end = start + SERVICES_PER_PAGE
    slice_services = SERVICES[start:end]

    for name, price in slice_services:
        count = services_count.get(name, 0)
        text = f"{name} (+1)" if count == 0 else f"{name} (+1) [{count}]"
        markup.insert(InlineKeyboardButton(text=text, callback_data=f"svc_{page}_{name}"))

    nav_buttons = []
    if start > 0:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"svc_page_{page-1}"))
    if end < len(SERVICES):
        nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è", callback_data=f"svc_page_{page+1}"))
    if nav_buttons:
        markup.row(*nav_buttons)

    markup.row(
        InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É", callback_data="toggle_delete"),
        InlineKeyboardButton("‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="svc_done")
    )

    if hasattr(message_or_callback, 'answer'):
        await message_or_callback.answer(header, reply_markup=markup)
    else:
        await message_or_callback.reply(header, reply_markup=markup)

# ----------------------
# –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ª—É–≥
# ----------------------
@dp.callback_query(Text(startswith="svc_page_"), StateFilter(ShiftStates.editing_car))
async def service_page_change(callback: CallbackQuery, state: FSMContext):
    _, _, page_str = callback.data.partition("_")
    page = int(page_str)
    await callback.message.delete()
    await show_services_page(callback, state, page)
    await callback.answer()

# ----------------------
# –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥
# ----------------------
@dp.callback_query(Text(equals="toggle_delete"), StateFilter(ShiftStates.editing_car))
async def toggle_delete_mode(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    delete_mode = data.get("delete_mode", False)
    await state.update_data(delete_mode=not delete_mode)
    await callback.answer("–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è " + ("–≤–∫–ª—é—á–µ–Ω" if not delete_mode else "–æ—Ç–∫–ª—é—á–µ–Ω"))

# ----------------------
# –í—ã–±–æ—Ä/—É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
# ----------------------
@dp.callback_query(Text(startswith="svc_"), StateFilter(ShiftStates.editing_car))
async def service_selected(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    delete_mode = data.get("delete_mode", False)
    _, _, rest = callback.data.partition("_")
    parts = rest.split("_", 1)
    if parts[0].isdigit():
        name = parts[1]
    else:
        await callback.answer()
        return
    services_count = data.get("services", {})
    count = services_count.get(name, 0)
    price = dict(SERVICES).get(name, 0)
    if delete_mode:
        count = max(0, count - 1)
    else:
        count += 1
    services_count[name] = count
    await state.update_data(services=services_count)
    await callback.answer(f"{name}: {count}")
    page = int(parts[0])
    await callback.message.delete()
    await show_services_page(callback, state, page)

# ----------------------
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—à–∏–Ω—ã
# ----------------------
@dp.callback_query(Text(equals="svc_done"), StateFilter(ShiftStates.editing_car))
async def service_done(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    car_number = data.get("car_number")
    services_count = data.get("services", {})
    services_list = [(name, cnt, price) for (name, price) in SERVICES for cnt in [services_count.get(name, 0)]]
    shift_id = get_active_shift()
    total = record_car(shift_id, car_number, services_list)
    svc_lines = [f"{name}√ó{cnt}" for name, cnt, price in services_list if cnt > 0]
    svc_text = ", ".join(svc_lines) if svc_lines else "‚Äì"
    text = f"–ú–∞—à–∏–Ω–∞ –∑–∞–ø–∏—Å–∞–Ω–∞: {car_number}\n–£—Å–ª—É–≥–∏: {svc_text}\n–ò—Ç–æ–≥–æ: {total} —Ä—É–±."
    await callback.message.answer(text)
    await callback.answer("–ú–∞—à–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.")
    await state.clear()
    await callback.message.answer("–ü–∞–Ω–µ–ª—å —Å–º–µ–Ω—ã:", reply_markup=get_shift_panel(active_shift=True))
# ----------------------
# –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
# ----------------------
@dp.message(Command(commands=["cancel"]), StateFilter(ShiftStates))
async def cancel_handler(message: Message, state: FSMContext):
    if message.from_user.id != OWNER_ID:
        return
    await state.clear()
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_shift_panel(active_shift=bool(get_active_shift())))

# ----------------------
# –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# ----------------------
@dp.message()
async def default_handler(message: Message):
    if message.from_user.id != OWNER_ID:
        return
    await message.answer("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.", reply_markup=get_shift_panel(active_shift=bool(get_active_shift())))

# ----------------------
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# ----------------------
if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    dp.run_polling(bot)